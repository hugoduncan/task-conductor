#!/usr/bin/env bash
set -euo pipefail

# Pre-commit hook: format with cljfmt, lint with clj-kondo

# Get staged Clojure files into array
mapfile -t staged_files < <(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(clj|cljs|cljc|edn)$' || true)

if [ ${#staged_files[@]} -eq 0 ]; then
  exit 0
fi

# Run cljfmt fix on all staged files at once and restage
cljfmt fix "${staged_files[@]}"
git add "${staged_files[@]}"

# Run clj-kondo on staged files, block on any findings (info+)
kondo_output=$(clj-kondo --lint "${staged_files[@]}" 2>&1) || true

if [ -n "$kondo_output" ]; then
  echo "$kondo_output"
fi

# Block on info+ findings
if echo "$kondo_output" | grep -qE '(info|warning|error):'; then
  echo "Pre-commit hook: clj-kondo found issues. Please fix before committing."
  exit 1
fi

exit 0
